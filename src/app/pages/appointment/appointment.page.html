<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-toolbar>
    <ion-buttons>
      <ion-button routerLink="/appointment/form" expand="full">

        <ion-header>
          <ion-item>
            <ion-icon slot="start" name="add-circle"></ion-icon>
            <ion-text>
              Agregar Cita
            </ion-text>
          </ion-item>
        </ion-header>

      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <!-- SECCIÓN DE AGENDA RÁPIDA (SLOTS DE DISPONIBILIDAD) -->
  <!-- <div class="container py-2 mb-5 p-0">
    <h3 class="fw-bold mb-3">Agenda Rápida (Slots)</h3>

    <ion-item class="rounded-item shadow-sm mb-3" lines="none">
      <ion-label position="stacked">Barbero para Agendar</ion-label>
      <ion-select interface="popover" 
                  [(ngModel)]="selectedBarberForSlots" 
                  (ionChange)="onBarberSelectForSlots($event)">
        <ion-select-option *ngFor="let barber of (barbers$ | async)" [value]="barber.id">
          {{ barber.name }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <div class="d-flex days-scroll mb-4">
      <ion-chip *ngFor="let day of days"
        [color]="day.dateString === selectedDayChip ? 'primary' : 'medium'"
        (click)="selectDay(day.dateString)"
        class="day-chip">
        <ion-label>
          {{ day.name }}.
          <span class="day-number">{{ day.date | date: 'dd' }}</span>
        </ion-label>
      </ion-chip>
    </div>

    <ion-grid *ngIf="(timeSlots$ | async) as slots" class="slot-grid">
      <ion-row class="slot-grid-header ion-padding-bottom">
        <ion-col size="12">
          <h4 class="fw-bold fs-6">
            Disponibilidad para {{ selectedBarberForSlots | uppercase }} el 
            {{ selectedDayChip | date: 'fullDate' }}
          </h4>
        </ion-col>
      </ion-row>

      <ion-row class="ion-text-center">
        <ion-col size="4" size-md="2" *ngFor="let slot of slots">
          <ion-button expand="block" mode="ios"
            [color]="slot.status === 'FREE' ? 'success' : (slot.status === 'BOOKED' ? 'danger' : 'light')"
            [disabled]="slot.status !== 'FREE'"
            (click)="navigateToForm(slot)"
            class="slot-button">
            {{ slot.time }}
            <ion-icon slot="start" 
                      [name]="slot.status === 'FREE' ? 'checkmark-circle' : (slot.status === 'BOOKED' ? 'close-circle' : 'time')">
            </ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>

      <ion-row *ngIf="slots.length === 0">
        <ion-col size="12" class="ion-text-center">
          <p>No hay slots disponibles para este día o barbero.</p>
        </ion-col>
      </ion-row>
    </ion-grid>
    <div *ngIf="!(timeSlots$ | async)" class="ion-text-center ion-padding">
        <ion-spinner name="crescent"></ion-spinner>
    </div>

  </div> -->

  <!-- SECCIÓN DE LISTA COMPLETA DE CITAS (Filtros y Contenido) -->
  <ion-text color="medium">
    <h4 class="ion-padding-start mt-2">Lista Completa de Citas Agendadas</h4>
  </ion-text>
  <ion-list>
    <ion-item class="ion-padding-start mt-2">
      <!-- Búsqueda de Cliente -->
      <ion-searchbar placeholder="Buscar por nombre de cliente" [(ngModel)]="searchTerm" debounce="300"
        showClearButton="always" (ionInput)="onSearchChange($event)" class="form-control p-0 border-0 shadow-none"
        style="--box-shadow: none;">
      </ion-searchbar>
    </ion-item>
    <!-- Selector de Fecha para FILTRO DE LISTA -->
    <ion-item>
      <ion-button slot="start" id="date" expand="block" >
        <ion-text>
          Filtrar Fecha
        </ion-text></ion-button>
      <ion-text slot="end" class="ion-padding-end">
        {{ selectedDateValue === 'all' ? 'Todas las fechas' : (selectedDateValue | date: 'dd/MM/yyyy') }}
      </ion-text>
      <ion-button fill="clear" color="danger" (click)="clearDateFilter()">
        <ion-icon name="close-circle-outline" slot="start"></ion-icon>
        <ion-text>
          Limpiar Filtro Fecha
        </ion-text>
      </ion-button>
    </ion-item>
  </ion-list>
  <ion-popover trigger="date">
    <ng-template>
      <ion-datetime 
      presentation="date" locale="es-ES" cancelText="Cancelar"
        doneText="Confirmar" (ionChange)="onDateChange($event)" showDefaultButtons="true"></ion-datetime>
    </ng-template>
  </ion-popover>

  <!-- LISTA DE CITAS -->
  <ion-list *ngIf="(filteredAppointments$ | async) as appointments; else loadingOrEmpty" lines="full">

    <div *ngIf="appointments.length === 0 && !(isLoading)">
      <ion-item lines="none">
        <ion-label class="ion-text-center">
          <h2>No hay citas agendadas que coincidan con los filtros.</h2>
          <p>Ajusta el nombre o la fecha.</p>
        </ion-label>
      </ion-item>
    </div>

    <ion-item-sliding *ngFor="let appointment of appointments">

      <ion-item [routerLink]="['/appointment/form', appointment.id]" detail>
        <ion-label>
          <h2 class="fw-bold">{{ appointment.clientName }}</h2>
          <p>Servicio: {{ appointment.service }}</p>
          <p>Barbero: {{ appointment.barberName }}</p>
          <p>Estado: {{ appointment.status }}</p>
        </ion-label>
        <p slot="end">
          <!-- Muestra la fecha y hora de la cita -->
          {{ appointment.date | date: 'dd/MM/yy hh:mm a' }}
        </p>
      </ion-item>

      <ion-item-options side="end">
        <ion-item-option color="danger" (click)="deleteAppointment(appointment.id!)">
          <ion-icon slot="icon-only" name="trash"></ion-icon>
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>

  </ion-list>

  <!-- Template para carga o lista vacía -->
  <ng-template #loadingOrEmpty>
      <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
      <ion-text *ngIf="!isLoading && searchTerm === '' && selectedBarberForSlots === 'all'">
        <p>Aún no tienes citas agendadas.</p>
      </ion-text>
  </ng-template>
</ion-content>
